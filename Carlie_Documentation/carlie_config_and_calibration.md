# Carlie Config and Calibration

## Config Parameters
The platform comes with some default parameters which set aspects such as acceleration and velocity limits. Fortunately these can all be easily changed through a YAML config file. The config file is located at **insert config file location**. In this file the config parameters/values will be commented out. You will need to uncomment them to override the defaults (the defaults are located at **file location**). To change the file:

1. Open up a terminal, either via the applications GUI or by pressing `ctrl+alt+t` on the keyboard.
2. Change directory to the location of the config file `cd file_location`.
3. Use Nano, or Vim, to edit the file `nano file_name`.
4. Uncomment the parameter you wish to specify and change the value.
5. Once completed save the file. In Nano this is done by pressing `ctrl+x` and then entering `y` to the question do you wish to overwrite this file.

The config values and their meaning are below. The following values you will wish to change depending on your application/environment (any parameters followed by (*) can be dynamically reconfigured; the calibration routine for the center_steering_angle parameter below shows you how you can update these at runtime):

* **max_reverse_velocity(*)** - this is the maximum reverse velocity you want the car to be able to go; specified in m/s and does require a negative sign (e.g. -1m/s).
* **max_forward_velocity(*)** - this is the maximum forward velocity you want the platform to go; specified in m/s.
* **acceleration(*)** - is the acceleration limit; specified in m/s/s.
* **ignore_proximity_sensors(*)** - set this to true to ignore the four short range LIDAR bumper sensors. The sensors will still be measured and reported but the vehicle will not stop. Current default is true as need to write a filter for spurious false-positives when the car is undulating.
* **collisision_detection_distance(*)** - the approximate distance in millimetres for when the LIDAR bumper sensors should stop the car.

The parameters associated with the low level odometry covariance you may wish to change, but you should not need to.
* **covar_position_<value>** - the covariance for various element of the reported odometry from the low level.

The following parameters are specific to your exact hardware and while the defaults will probably be sufficient you may wish to calibrate them (see below). The parameter you will probably wish to calibrate is the center_steering_angle, else you may get a left/right drift when wanting to drive straight.
* **min_throttle_pulse_width** - the minimum throttle (linear velocity) pulse width generated by the RC remote; specified in micro-seconds should be approximately 1000us.
* **max_throttle_pulse_width** - the maximum throttle (linear velocity) pulse width generated by the RC remote; specified in micro-seconds should be approximately 2000us.
* **center_throttle_pulse_width** - the pulse generated when the RC throttle is in its neutral position; specified in micro-seconds should be approximately 1500us.
* **min_steering_angle** - the minimum steering angle possible by the car (wheels are facing to the right when looking in direction of travel); specified in radians and should be negative (e.g. -0.7854 radians).
* **max_steering_angle** - the maximum steering angle possible by the car (wheels are facing to the left when looking in direction of travel); specified in radians default.
* **center_steering_angle(*)** - placing the steering servo so 100 degrees corresponds to exactly straight is impossible, hence this parameter. This specifies the center position of the steering; units are in radians and should be approximately 1.75 radians (100 degrees).
* **min_steering_angle_pulse_width** - the minimum pulse width generated by the RC remote when steering; specified in micro-seconds should be approximately 1000us.
* **max_steering_angle_pulse_width** - the maximum pulse width generated by the RC remote when steering; specified in micro-seconds should be approximately 2000us.
* **lidar_front_right_address** - the I2C address of the front right LIDAR bumper sensor.
* **lidar_front_left_address** - the I2C address of the front left LIDAR bumper sensor.
* **lidar_back_right_address** - the I2C address of the back right LIDAR bumper sensor.
* **lidar_back_left_address** - the I2C address of the back left LIDAR bumper sensor.

The following parameters should not need to be changed. They are merely broken out as config values for ease of use, so the Teensy does not need to be reprogrammed each time.
* **wheel_base** - the distance between the front and rear axle of the platform; specified in metres.
* **wheel_radius** - the radius of the wheels; specified in metres defaults to 0.059m.
* **gear_ratio_wheel_2_motor** - the gear ratio from the wheel to the motor, should be a value greater than 1.
* **motor_poles** - the number of motor poles, as specified by the VESC documentation. We believe the VESC documentation is wrong as the motor should have more than 1 pole, but the conversion required to go from E-RPM to RPM is only sensible if you use a value of 1 here.
* **motor_ticks_per_revolution** - the number of motor ticks per single revolution.
* **battery_voltage_offset** - the offset between the battery voltage measured by the VESC and the actual voltage due to voltage offsets caused by components such as diodes (this should be approximately constant); specified in volts.

## Calibrating Carlie

The main parameter you will need to calibrate is the center_steering_angle. The easiest way to calibrate the steering angle is as follows:

1. Turn on the car and make sure it is in Logitech Tele-Operation mode.
2. Manually drive the car forward a few metres and see if there is any left/right drift.
3. If there is drift slightly alter the center_steering_angle parameter by opening up a terminal and running the command `rosparam set center_steering_angle <value>`. If it is steering left add(?) to this value, if right subtract(?) from it.
4. Repeat steps 2 and 3 until you are happy with the result. You will most likely not be able to get a car that can drive perfectly straight over a long straight due to the fact the discritization of the angles the servo can physically achieve.
5. Once you are happy with the result you will need to make the change official by updating the local config file. To do this follow the steps outlined above. If you cannot remember what value you set the center_steering_angle parameter to run the following command `rosparam get center_steering_angle`.

The default pulse width RC remote parameters will do in most cases. However, we do recommend you calibrate them. To calibrate:

1. Somehow upload the calibration firmware. Gavin this is on you
2. James how do they use it?

**Tip:** on the side of the RC remote there is a steering trim knob. If this is steering trim does not align with the value specified in the *center_throttle_pulse_width* parameter your car will drift left or right. Changing the steering trim will change the wheel alignment. However, we recommend first set the *center_steering_angle* parameter as outlined below. After setting this parameter set the steering trim knob to the neutral position, or as close as possible (1500us pulse width). Then calibrate the pulse width parameters, again see below for calibration routine. Then when you are using the RC remote changing the steering trim should not cause errors in reported measurements due to a mismatch in offsets.